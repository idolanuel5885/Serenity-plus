'use client';

import { useEffect, useRef, useState } from 'react';
import Lottie from 'lottie-react';
// Import the animation data
const lotusAnimationData = {
  "nm":"LOTUS OPEN 3","ddd":0,"h":488,"w":1008,"meta":{"g":"@lottiefiles/toolkit-js 0.67.2"},"layers":[{"ty":3,"nm":"Null 1","sr":1,"st":0,"op":421,"ip":0,"hd":true,"ln":"106","hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[0,0]},"s":{"a":0,"k":[432,432,99.769]},"p":{"a":0,"k":[496,222,0]},"r":{"a":0,"k":0},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}},"ind":1},{"ty":3,"nm":"Nul petal","sr":1,"st":0,"op":480,"ip":176,"hd":true,"ln":"148","hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[0,0]},"s":{"a":0,"k":[9.083,9.083,100]},"p":{"a":1,"k":[{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[-10.649,32.698,0],"t":187.999},{"s":[-21.912,35.241,0],"t":294.998}]},"r":{"a":0,"k":41},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}},"ind":2,"parent":1},{"ty":3,"nm":"Nul petal 2","sr":1,"st":0,"op":480,"ip":176,"hd":true,"ln":"151","hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[0,0]},"s":{"a":0,"k":[8.719,8.719,100]},"p":{"a":1,"k":[{"o":{"x":0.166,"y":0},"i":{"x":0.584,"y":-2.504},"s":[11.058,30.881,0],"t":187.999},{"s":[25.325,34.006,0],"t":294.998}]},"r":{"a":0,"k":-48.1},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}},"ind":3,"parent":1},{"ty":4,"nm":"LOW_L","sr":1,"st":-2700,"op":421,"ip":0,"ln":"77","hasMask":false,"ao":0,"ks":{"a":{"a":0,"k":[187.5,406,0]},"s":{"a":0,"k":[100,100]},"p":{"a":1,"k":[{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[-0.5,98.5,0],"t":105.978},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[-0.5,104.3,0],"t":186.977},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[-0.5,103.1,0],"t":205.977},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[-0.5,99.514,0],"t":268.976},{"s":[-0.5,98.5,0],"t":358.976}]},"r":{"a":0,"k":0},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}},"shapes":[{"ty":"gr","nm":"Lotus Icon w BG","it":[{"ty":"gr","nm":"Lotus Animated","it":[{"ty":"gr","nm":"Lotus","it":[{"ty":"gr","nm":"Left Leaf","it":[{"ty":"sh","nm":"Path 1","d":1,"ks":{"a":1,"k":[{"o":{"x":0.167,"y":0.001},"i":{"x":0.833,"y":1},"s":[{"c":true,"i":[[-1.061,-0.989],[16.213,0.543],[0,0],[-17.086,0.229]],"o":[[-1.054,0.981],[-17.1,-0.555],[0,0],[15.688,-0.217]],"v":[[32.777,0.004],[0.537,12.344],[-31.805,-10.293],[-0.371,-13.824]]}],"t":-0.022},{"o":{"x":0.167,"y":0},"i":{"x":0.833,"y":0.998},"s":[{"c":true,"i":[[-1.061,-0.989],[17.076,0.979],[0,0],[-17.832,0.205]],"o":[[-1.054,0.981],[-17.737,-0.988],[0,0],[15.689,-0.194]],"v":[[32.777,0.004],[0.521,12.8],[-31.98,-10.469],[-0.371,-13.276]]}],"t":62.978},{"o":{"x":0.167,"y":0.004},"i":{"x":0.833,"y":1},"s":[{"c":true,"i":[[-1.061,-0.989],[16.628,0.999],[0,0],[-19.644,0.147]],"o":[[-1.647,1.27],[-19.772,-1.185],[0,0],[15.689,-0.138]],"v":[[36.545,4.019],[0.508,13.194],[-28.337,-16.675],[-0.371,-11.944]]}],"t":125.977},{"o":{"x":0.167,"y":0},"i":{"x":0.833,"y":1},"s":[{"c":true,"i":[[-1.061,-0.989],[15.559,1.046],[0,0],[-23.966,0.006]],"o":[[-1.054,0.982],[-24.625,-1.655],[0,0],[15.69,-0.004]],"v":[[33.157,10.084],[0.476,14.135],[-35.592,12.829],[-0.371,-8.767]]}],"t":267.976},{"s":[{"c":true,"i":[[-1.061,-0.989],[15.559,1.046],[0,0],[-23.966,0.006]],"o":[[-1.054,0.982],[-24.625,-1.655],[0,0],[15.69,-0.004]],"v":[[33.016,9.473],[0.335,13.524],[-35.733,12.218],[-0.512,-9.378]]}],"t":358.976}]}},{"ty":"gf","nm":"Gradient Fill 1","e":{"a":0,"k":[94,29]},"g":{"p":3,"k":{"a":0,"k":[0,0.50112379,0.24801581,0.93464047,0.5,0.750561895,0.6240079050000001,0.9673202349999999,1,1,1,1]}},"t":2,"a":{"a":0,"k":0},"h":{"a":0,"k":0},"s":{"a":0,"k":[-118,-21]},"r":1,"o":{"a":0,"k":100}},{"ty":"tr","a":{"a":0,"k":[32.788,0.371]},"s":{"a":0,"k":[100,100]},"p":{"a":1,"k":[{"o":{"x":0.431,"y":0.431},"i":{"x":0.824,"y":0.824},"s":[188.721,286.919],"t":-0.022},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[188.721,286.919],"t":62.978},{"s":[188.721,276.919],"t":267.976}]},"r":{"a":1,"k":[{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":-30.021},{"o":{"x":0.334,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":-0.022},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":62.978},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":205.977},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":358.976},{"o":{"x":0.167,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":689.973},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":749.972},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":869.971},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":927.971},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[21],"t":928.637},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":1047.97},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":1107.97},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":1229.969},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":1289.968},{"o":{"x":0.167,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":1409.967},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":1471.967},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":1589.966},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":1649.965},{"o":{"x":0.167,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":1769.964},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":1829.964},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":1949.963},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":2009.962},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":2127.961},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[0],"t":2187.961},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":2309.96},{"o":{"x":0.333,"y":0},"i":{"x":0.667,"y":1},"s":[74],"t":2369.959},{"s":[0],"t":2489.958}]},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}}]},{"ty":"tr","a":{"a":0,"k":[188.703,260.472]},"s":{"a":1,"k":[{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[120,120],"t":-0.022},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[133,133],"t":358.976},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[133,133],"t":719.973},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[120,120],"t":899.971},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[133,133],"t":1079.97},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[120,120],"t":1259.968},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[133,133],"t":1439.967},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[120,120],"t":1619.965},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[133,133],"t":1799.964},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[120,120],"t":1979.963},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[133,133],"t":2159.961},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[120,120],"t":2339.96},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[133,133],"t":2519.958},{"o":{"x":0.167,"y":0.167},"i":{"x":0.833,"y":0.833},"s":[120,120],"t":2699.957},{"s":[133,133],"t":2879.955}]},"p":{"a":1,"k":[{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,319.472],"t":-0.022},{"o":{"x":0.79,"y":0.79},"i":{"x":0.15,"y":0.15},"s":[187.703,299.472],"t":358.976},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,299.472],"t":719.973},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,319.472],"t":899.971},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,299.472],"t":1079.97},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,319.472],"t":1259.968},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,299.472],"t":1439.967},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,319.472],"t":1619.965},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,299.472],"t":1799.964},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,319.472],"t":1979.963},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,299.472],"t":2159.961},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,319.472],"t":2339.96},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,299.472],"t":2519.958},{"o":{"x":0.85,"y":0},"i":{"x":0.15,"y":1},"s":[187.703,319.472],"t":2699.957},{"s":[187.703,299.472],"t":2879.955}]},"r":{"a":0,"k":0},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}}]},{"ty":"tr","a":{"a":0,"k":[188,265.894]},"s":{"a":0,"k":[100,100]},"p":{"a":0,"k":[188,265.894]},"r":{"a":0,"k":0},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}}]},{"ty":"tr","a":{"a":0,"k":[188,308]},"s":{"a":0,"k":[100,100]},"p":{"a":0,"k":[188,308]},"r":{"a":0,"k":0},"sa":{"a":0,"k":0},"o":{"a":0,"k":100}}]}],"ind":4,"parent":1}],"v":"5.7.0","fr":60,"op":417,"ip":0,"assets":[]}

interface LotusAnimationProps {
  progress: number; // 0-100, represents the current progress of the lotus opening
  isActive: boolean; // whether the meditation is currently active
  duration: number; // total duration of the current meditation in seconds
  elapsed: number; // elapsed time in the current meditation in seconds
}

export default function LotusAnimation({ 
  progress, 
  isActive, 
  duration, 
  elapsed 
}: LotusAnimationProps) {
  const lottieRef = useRef<any>(null);
  const [currentProgress, setCurrentProgress] = useState(0);

  // Update current progress when base progress changes
  useEffect(() => {
    setCurrentProgress(progress);
  }, [progress]);

  // Update current progress when session completes
  useEffect(() => {
    if (!isActive && duration > 0 && elapsed >= duration) {
      // Session completed - calculate final progress
      const sessionContribution = (1 / (duration / 60)) * 100; // Each session contributes this percentage
      const totalProgress = Math.min(progress + sessionContribution, 100);
      setCurrentProgress(totalProgress);
    }
  }, [isActive, elapsed, duration, progress]);

  // Handle animation during active meditation
  useEffect(() => {
    if (lottieRef.current) {
      if (isActive && duration > 0) {
        // During active meditation, calculate session progress
        const sessionProgress = Math.min((elapsed / duration) * 100, 100);
        const totalProgress = Math.min(progress + sessionProgress, 100);
        setCurrentProgress(totalProgress);
        
        const targetFrame = Math.floor((totalProgress / 100) * 417);
        lottieRef.current.goToAndStop(targetFrame, true);
      } else {
        // When not active (paused or completed), show the last known progress
        // Don't reset to 0, maintain the current state
        const displayProgress = Math.max(currentProgress, progress);
        const targetFrame = Math.floor((displayProgress / 100) * 417);
        lottieRef.current.goToAndStop(targetFrame, true);
      }
    }
  }, [isActive, elapsed, duration, progress, currentProgress]);

  return (
    <div className="flex justify-center items-center py-8">
      <div className="w-64 h-64 relative">
        <Lottie
          lottieRef={lottieRef}
          animationData={lotusAnimationData}
          loop={false}
          autoplay={false}
          style={{ width: '100%', height: '100%' }}
        />
        
        {/* Progress indicator overlay */}
        <div className="absolute bottom-4 left-1/2 transform -translate-x-1/2 bg-black/50 text-white px-3 py-1 rounded-full text-sm">
          {Math.round(progress)}% open
        </div>
      </div>
    </div>
  );
}
