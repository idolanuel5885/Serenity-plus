# Session ID Explanation

## What is the Session ID?

The **session ID** is a **UUID (Universally Unique Identifier)** - a 128-bit identifier that looks like:
```
550e8400-e29b-41d4-a716-446655440000
```

## How is it Created?

### 1. Database-Level Auto-Generation
The session ID is **automatically generated by PostgreSQL** when a new session record is inserted into the database.

**Database Schema** (`create-session-table.sql`):
```sql
CREATE TABLE sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  -- ... other columns
);
```

**Key Points:**
- `id UUID` - The column type is UUID
- `PRIMARY KEY` - It's the unique identifier for each session
- `DEFAULT gen_random_uuid()` - PostgreSQL automatically generates a random UUID when no ID is provided

### 2. Application Code Flow

**Step 1: Timer Starts** (`src/app/timer/page.tsx` line 205-232)
```typescript
const startTimer = async () => {
  // ... timer logic
  
  const response = await fetch('/api/session-complete', {
    method: 'POST',
    body: JSON.stringify({
      userId: user.id,
      partnershipId,
      sessionDuration: user.usualSitLength * 60,
      sessionStarted: true  // ← This triggers session creation
    }),
  });
}
```

**Step 2: API Creates Session** (`src/app/api/session-complete/route.ts` line 57-67)
```typescript
// Session started - create session record
const { data: sessionData, error: sessionError } = await supabase
  .from('sessions')
  .insert({
    userid: userId,
    partnershipid: partnershipId,
    duration: sessionDuration,
    iscompleted: false
    // ← Notice: NO 'id' field is provided!
  })
  .select()  // ← This returns the created record including the auto-generated ID
  .maybeSingle();
```

**Step 3: Database Generates ID**
- When the `INSERT` happens, PostgreSQL sees that no `id` was provided
- It automatically calls `gen_random_uuid()` to generate a unique UUID
- The UUID is stored as the `id` column value

**Step 4: API Returns ID** (line 84-90)
```typescript
return NextResponse.json({
  success: true,
  data: {
    sessionId: sessionData.id,  // ← The auto-generated UUID
    message: 'Session started'
  }
});
```

**Step 5: Frontend Receives but Doesn't Store** (line 225-228)
```typescript
if (response.ok) {
  const result = await response.json();
  console.log('Session started:', result.data);
  // ← sessionId is in result.data.sessionId but NOT stored in state!
}
```

## The Problem

**The session ID is created and returned, but never stored!**

1. ✅ Session is created with auto-generated UUID
2. ✅ API returns the session ID in the response
3. ❌ Frontend logs it but doesn't save it to state
4. ❌ When timer completes, frontend has no way to reference the specific session
5. ❌ API has to search for session by `userid + partnershipid + iscompleted = false` instead of using the ID

## What Should Happen

The frontend should store the session ID:

```typescript
const [currentSessionId, setCurrentSessionId] = useState<string | null>(null);

const startTimer = async () => {
  // ... timer logic
  
  const response = await fetch('/api/session-complete', {
    // ... request
  });
  
  if (response.ok) {
    const result = await response.json();
    setCurrentSessionId(result.data.sessionId);  // ← Store it!
  }
};

// Then when completing:
const completeSession = async () => {
  await fetch('/api/session-complete', {
    body: JSON.stringify({
      sessionId: currentSessionId,  // ← Use the stored ID
      completed: true
    })
  });
};
```

## UUID Format

UUIDs follow this format:
- **Version 4 (Random)**: `xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx`
- Example: `a1b2c3d4-e5f6-4789-a012-b3c4d5e6f789`
- **36 characters** total (32 hex digits + 4 hyphens)
- **Guaranteed unique** (practically speaking - collision probability is negligible)

## Summary

| Aspect | Details |
|--------|---------|
| **Type** | UUID (Universally Unique Identifier) |
| **Format** | 36 characters: `xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx` |
| **Generation** | Automatic by PostgreSQL using `gen_random_uuid()` |
| **When** | At INSERT time, if no ID is provided |
| **Where** | Database level (not application code) |
| **Current Status** | ✅ Created correctly<br>❌ Not stored in frontend<br>❌ Not used for updates |

